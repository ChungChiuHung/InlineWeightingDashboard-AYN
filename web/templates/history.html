{% extends "base.html" %}

{% block content %}
<h2>歷史紀錄</h2>

<!-- Query Panel -->
<div class="query-panel">
  <label>
    起始時間
    <input type="datetime-local" id="startTime">
  </label>

  <label>
    結束時間
    <input type="datetime-local" id="endTime">
  </label>

  <label>
    資料項目
    <select id="tagSelect">
      <option value="weight_now">即時秤重</option>
      <option value="total_weight">總重</option>
      <option value="total_count">總隻數</option>
      <option value="bucket1_count">分規1隻數</option>
      <option value="bucket2_count">分規2隻數</option>
      <option value="bucket3_count">分規3隻數</option>
      <option value="bucket4_count">分規4隻數</option>
      <option value="bucket5_count">分規5隻數</option>
      <option value="bucket6_count">分規6隻數</option>
      <option value="bucket7_count">分規7隻數</option>
    </select>
  </label>

  <button onclick="queryHistory()">查詢</button>
</div>

<!-- Table -->
<div class="table-panel">
  <table id="historyTable">
    <thead>
      <tr>
        <th>時間</th>
        <th>數值</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Chart -->
<div class="chart-panel">
  <canvas id="historyChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

function toTs(dt) {
  return Math.floor(new Date(dt).getTime() / 1000);
}

async function queryHistory() {
  const tag = document.getElementById("tagSelect").value;
  const start = toTs(document.getElementById("startTime").value);
  const end = toTs(document.getElementById("endTime").value);

  const res = await fetch(`/history/${tag}?start=${start}&end=${end}`);
  const data = await res.json();

  renderTable(data);
  renderChart(data, tag);
}

function renderTable(data) {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(row.ts * 1000).toLocaleString()}</td>
      <td>${row.value}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderChart(data, tag) {
  const labels = data.map(d =>
    new Date(d.ts * 1000).toLocaleTimeString()
  );
  const values = data.map(d => d.value);

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("historyChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: tag,
        data: values,
        borderWidth: 2,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { display: true },
        y: { display: true }
      }
    }
  });
}

/* default time range = today */
(function init() {
  const now = new Date();
  const start = new Date(now.getTime() - 3600 * 1000);

  document.getElementById("startTime").value =
    start.toISOString().slice(0,16);
  document.getElementById("endTime").value =
    now.toISOString().slice(0,16);
})();
</script>

<style>
.query-panel {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin: 16px 0;
  align-items: flex-end;
}

.query-panel label {
  display: flex;
  flex-direction: column;
  font-size: 13px;
}

.query-panel button {
  padding: 8px 16px;
}

.table-panel {
  background: #fff;
  border-radius: 6px;
  overflow: auto;
  max-height: 300px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #e5e7eb;
  padding: 8px;
  text-align: center;
  font-size: 13px;
}

th {
  background: #f3f4f6;
}

.chart-panel {
  background: #fff;
  margin-top: 16px;
  padding: 12px;
  border-radius: 6px;
}
</style>

{% endblock %}
