{% extends "base.html" %}

{% block content %}
<h2>分規資訊管理</h2>

<form id="bucketForm" class="bucket-form">
  <table class="bucket-table">
    <thead>
      <tr>
        <th>分規</th>
        <th>最小值 (g)</th>
        <th>最大值 (g)</th>
      </tr>
    </thead>
    <tbody>
      {% for i in range(1, 8) %}
      <tr>
        <td>分規 {{ i }}</td>
        <td>
          <input type="number" step="1"
                 id="bucket{{ i }}_min"
                 data-tag="bucket{{ i }}_min">
        </td>
        <td>
          <input type="number" step="1"
                 id="bucket{{ i }}_max"
                 data-tag="bucket{{ i }}_max">
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="form-actions">
    <button type="button" class="btn secondary" onclick="reloadValues()">回復</button>
    <button type="submit" class="btn primary">儲存</button>
  </div>
</form>

<script>
async function loadCurrentValues() {
  const res = await fetch("/tags");
  const tags = await res.json();

  document.querySelectorAll("input[data-tag]").forEach(input => {
    const tag = input.dataset.tag;
    if (tags[tag] !== undefined) {
      input.value = tags[tag];
    }
  });
}

async function saveValues(e) {
  e.preventDefault();

  if (!confirm("確認寫入分規參數？")) {
    return;
  }

  const inputs = document.querySelectorAll("input[data-tag]");
  for (const input of inputs) {
    const tag = input.dataset.tag;
    const value = input.value;

    if (value === "") continue;

    const res = await fetch(`/write/${tag}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ value: Number(value) })
    });

    if (!res.ok) {
      const err = await res.text();
      alert(`寫入 ${tag} 失敗：${err}`);
      return;
    }
  }

  alert("分規參數已成功寫入");
}

function reloadValues() {
  loadCurrentValues();
}

document.getElementById("bucketForm").addEventListener("submit", saveValues);
loadCurrentValues();
</script>

<style>
.bucket-form {
  margin-top: 16px;
}

.bucket-table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}

.bucket-table th,
.bucket-table td {
  border: 1px solid #e5e7eb;
  padding: 10px;
  text-align: center;
}

.bucket-table th {
  background: #f3f4f6;
  font-size: 14px;
}

.bucket-table input {
  width: 100%;
  padding: 6px;
  font-size: 14px;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 16px;
}

.btn {
  padding: 8px 16px;
  font-size: 14px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
}

.btn.primary {
  background: #2563eb;
  color: #fff;
}

.btn.secondary {
  background: #e5e7eb;
}
</style>

{% endblock %}
